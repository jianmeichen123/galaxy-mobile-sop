<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.galaxyinternet.rili.model.ScheduleInfo">

	<resultMap id="BaseResultMap" type="com.galaxyinternet.rili.model.ScheduleInfo">
		<id column="id" 				property="id" 			jdbcType="BIGINT" />
		<result column="type" 			property="type" 		jdbcType="TINYINT" />
		
		<result column="name_id" 		property="nameId" 		jdbcType="BIGINT" />
		
		<result column="name" 			property="name" 		jdbcType="VARCHAR" />
		<result column="parent_id"  	property="parentId" 	jdbcType="BIGINT" />
		<result column="project_type" 	property="projectType" 	jdbcType="TINYINT" />
		<result column="project_id" 	property="projectId" 	jdbcType="BIGINT" />
		<result column="start_time" 	property="startTime" 	jdbcType="TIMESTAMP"/>
		<result column="end_time" 		property="endTime" 		jdbcType="TIMESTAMP"/>
		<result column="is_allday" 		property="isAllday" 	jdbcType="TINYINT" />
		<result column="wakeup_id" 		property="wakeupId" 	jdbcType="BIGINT" />
		<result column="remark" 		property="remark" 		jdbcType="VARCHAR" />
		<result column="created_id"		property="createdId" 	jdbcType="BIGINT" />
		<result column="updated_id" 	property="updatedId" 	jdbcType="BIGINT" />
		<result column="created_time" 	property="createdTime" 	jdbcType="BIGINT" />
		<result column="updated_time" 	property="updatedTime" 	jdbcType="BIGINT" />
		<result column="is_del" 		property="isDel" 		jdbcType="TINYINT" />
		<result column="callon_person"		property="callonPerson" 	jdbcType="BIGINT" />
	</resultMap>


	<sql id="Base_Column_List">
		id, type, name_id, name, parent_id, project_type, project_id, start_time, end_time, is_allday, wakeup_id, remark, created_id, 
    	updated_id, created_time, updated_time, is_del, callon_person
	</sql>


	<sql id="Base_Where_Clause">
		<where>
			<trim prefixOverrides="and">
				<if test="id != null"> and id = #{id,jdbcType=BIGINT} </if>
				<if test="type != null" > and type = #{type,jdbcType=TINYINT} </if>
				
				<if test="nameId != null"> and name_id = #{nameId,jdbcType=BIGINT} </if>
				<if test="idIsNotEq != null"> and id != #{idIsNotEq,jdbcType=BIGINT} </if>
				<if test="name != null" > and name = #{name,jdbcType=VARCHAR} </if>
				<if test="parentId != null" > and parent_id = #{parentId,jdbcType=BIGINT} </if>
				<if test="projectType != null" > and project_type = #{projectType,jdbcType=TINYINT} </if>
				
				<if test="projectId != null" > and project_id = #{projectId,jdbcType=BIGINT} </if>
				<if test="startTime != null" > and start_time = #{startTime,jdbcType=TIMESTAMP} </if>
				<if test="endTime != null" > and end_time = #{endTime,jdbcType=TIMESTAMP} </if>
				<if test="isDel != null" > and is_del = #{isDel ,jdbcType=TINYINT}  </if>
				<if test="queryForMounth == null">
					<if test="bqStartTime != null"> <![CDATA[  and start_time >= #{bqStartTime} ]]> </if>
				    <if test="bqEndTime != null"> <![CDATA[ and start_time <= #{bqEndTime} ]]> </if>
				    <if test="eqStartTime != null"> <![CDATA[  and end_time >= #{eqStartTime} ]]> </if>
			    </if>
			    
			    <if test="queryForMounth != null">
				    <![CDATA[ and (start_time <= #{bqEndTime} ]]>
				    <![CDATA[  and end_time >= #{eqStartTime} ]]>
					and is_allday = 0
					or (
						<![CDATA[  start_time >= #{sbTimeForAllday} ]]>
					    <![CDATA[  and start_time <= #{seTimeForAllday} ]]>
						and is_allday = 1 
						)
					)
			    
			    </if>
    			
    
				<if test="isAllday != null" > and is_allday = #{isAllday,jdbcType=TINYINT} </if>
				<if test="wakeupId != null" > and wakeup_id = #{wakeupId,jdbcType=BIGINT} </if>
				<if test="remark != null" > and remark = #{remark,jdbcType=VARCHAR} </if>
				<if test="createdId != null" > and created_id = #{createdId,jdbcType=BIGINT} </if>
				<if test="updatedId != null" > and updated_id = #{updatedId,jdbcType=BIGINT} </if>
				<if test="createdTime != null" > and created_time = #{createdTime,jdbcType=BIGINT} </if>
				<if test="updatedTime != null" > and updated_time = #{updatedTime,jdbcType=BIGINT} </if>
				<if test="callonPerson != null" > and callon_person = #{callonPerson,jdbcType=BIGINT} </if>
				<!-- 
				<if test="ids != null">
					AND project_id IN
					<foreach collection="ids" index="item" item="item" open="("
						separator="," close=")">
						#{item}
					</foreach>
				</if> 
				-->
			</trim>
			
			<if test="sorting != null">order by ${sorting}</if>
			<if test="property != null">order by ${property} ${direction}</if>
			
			<if test="offset != null and limit != null">
				limit #{offset}, #{limit}
			</if>
		</where>
	</sql>


	<insert id="insert" useGeneratedKeys="true" keyProperty="id" parameterType="com.galaxyinternet.rili.model.ScheduleInfo">
	    <![CDATA[
	    insert into schedule_info (id, type, name_id, name, parent_id, project_type, 
	      project_id, start_time, end_time, 
	      is_allday, wakeup_id, remark, 
	      created_id, updated_id, created_time, 
	      updated_time, is_del, callon_person)
	    values (#{id,jdbcType=BIGINT}, #{type,jdbcType=TINYINT}, #{nameId,jdbcType=BIGINT}, #{name,jdbcType=VARCHAR}, #{parentId,jdbcType=BIGINT}, #{projectType,jdbcType=TINYINT}, 
	      #{projectId,jdbcType=BIGINT}, #{startTime}, #{endTime}, 
	      #{isAllday,jdbcType=TINYINT}, #{wakeupId,jdbcType=BIGINT}, #{remark,jdbcType=VARCHAR}, 
	      #{createdId,jdbcType=BIGINT}, #{updatedId,jdbcType=BIGINT}, #{createdTime,jdbcType=BIGINT}, 
	      #{updatedTime,jdbcType=BIGINT}, #{isDel,jdbcType=TINYINT}, #{callonPerson,jdbcType=BIGINT})
	    ]]>
	</insert>
	
				
				
	<!-- 查询总数 -->
	<select id="selectCount" resultType="java.lang.Long" parameterType="java.util.Map">
		select count(id) from schedule_info
		<include refid="Base_Where_Clause" />
	</select>



	<!-- 查询 -->
	<select id="select" resultMap="BaseResultMap" parameterType="java.util.Map">
		select
		<include refid="Base_Column_List" />
		from schedule_info
		<include refid="Base_Where_Clause" />
	</select>


	<!-- 根据ID查询 -->
	<select id="selectById" resultMap="BaseResultMap" parameterType="java.lang.Long">
		select
		<include refid="Base_Column_List" />
		from schedule_info 
		where id = #{id}
		and is_del= 0
	</select>
	
	
	<!-- 通过ID更新 -->
	<update id="updateById" parameterType="com.galaxyinternet.rili.model.ScheduleInfo">
		update schedule_info
		<set>
			<if test="type != null" > type = #{type,jdbcType=TINYINT}, </if>
			<if test="nameId != null"> name_id = #{nameId,jdbcType=BIGINT}, </if>
			<if test="name != null" > name = #{name,jdbcType=VARCHAR}, </if>
			<if test="parentId != null" > parent_id = #{parentId,jdbcType=BIGINT}, </if>
			<if test="projectType != null" > project_type = #{projectType,jdbcType=TINYINT}, </if>
			<if test="projectId != null" > project_id = #{projectId,jdbcType=BIGINT}, </if>
			<if test="startTime != null" > start_time = #{startTime,jdbcType=TIMESTAMP}, </if>
			 end_time = #{endTime,jdbcType=TIMESTAMP},
			<if test="isAllday != null" > is_allday = #{isAllday,jdbcType=TINYINT}, </if>
			<if test="wakeupId != null" > wakeup_id = #{wakeupId,jdbcType=BIGINT}, </if>
			 remark = #{remark,jdbcType=VARCHAR}, 
			<if test="createdId != null" > created_id = #{createdId,jdbcType=BIGINT}, </if>
			<if test="updatedId != null" > updated_id = #{updatedId,jdbcType=BIGINT}, </if>
			<if test="createdTime != null" > created_time = #{createdTime,jdbcType=BIGINT}, </if>
			<if test="updatedTime != null" > updated_time = #{updatedTime,jdbcType=BIGINT}, </if>
			<if test="isDel != null" > is_del = #{isDel,jdbcType=TINYINT}, </if>
			<if test="callonPerson != null" > callon_person = #{callonPerson,jdbcType=BIGINT} </if>
		</set>
		where id = #{id}
	</update>
	
	
	<!-- 删除 -->
	<delete id="delete" parameterType="java.util.Map">
		delete from schedule_info
		<include refid="Base_Where_Clause" />
	</delete>
	
	
	
	<!-- 根据ID删除 -->
	<delete id="deleteById" parameterType="java.lang.Long">
		delete from schedule_info
		where id = #{id}
	</delete>



	<!-- 查询日程冲突的list -->
	<select id="selectConflictSchedule" resultMap="BaseResultMap" parameterType="java.util.Map">
		select
		id, type, name_id, name
		from schedule_info
		<where>
			<trim prefixOverrides="and">
			
				<if test="idIsNotEq != null"> and id != #{idIsNotEq,jdbcType=BIGINT} </if>
				
			    <if test="bqEndTime != null"> <![CDATA[ and (start_time <= #{bqEndTime} ]]> </if>
			    <if test="eqStartTime != null"> <![CDATA[  and end_time >= #{eqStartTime} ]]> </if>
				and is_allday = 0
				or (
					<if test="sbTimeForAllday != null"> <![CDATA[  start_time >= #{sbTimeForAllday} ]]> </if>
				    <if test="seTimeForAllday != null"> <![CDATA[  and start_time <= #{seTimeForAllday} ]]> </if>
					and is_allday = 1 
				
				)
				)
				<if test="createdId != null" > and created_id = #{createdId,jdbcType=BIGINT} </if>
				<if test="isDel != null" > and is_del = #{isDel,jdbcType=TINYINT} </if>

			</trim>
			
		</where>
	</select>

	<!-- 连表查询获取拜访对象 -->
<!-- 	<select id="selectVisitNameById"   resultType ="com.galaxyinternet.rili.model.ScheduleInfo" parameterType="java.lang.Long">
		SELECT con.name as schedulePerson ,
				sc.id as id
				FROM 
			schedule_info sc LEFT JOIN schedule_person_plan spp ON spp.schedule_id=sc.id
				LEFT JOIN schedule_contacts con ON spp.contacts_id=con.id
				WHERE sc.id=#{id};
	</select> -->

	<select id="selectVisitNameById"   resultType ="com.galaxyinternet.rili.model.ScheduleInfo" parameterType="java.lang.Long">
		SELECT con.name as schedulePerson ,
				sc.id as id
				FROM 
				schedule_info sc 
				LEFT JOIN schedule_contacts con ON sc.callon_person=con.id
				WHERE sc.id=#{id};
	</select>
	
</mapper>
	